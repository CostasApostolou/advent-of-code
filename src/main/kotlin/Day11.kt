import kotlin.math.max
import kotlin.math.min

fun main() {
    println(solvePart1(sampleInput))
    println(solvePart1(input))

    println(solve(sampleInput, 10))
    println(solve(sampleInput, 100))
    println(solvePart2(input))
}

private fun solvePart1(input: String): Long = solve(input, 2)
private fun solvePart2(input: String): Long = solve(input, 1_000_000)

private fun solve(input: String, dilation: Long): Long {
    val cosmos = Cosmos.create(input, dilation)
    cosmos.expand()
    cosmos.locateGalaxies()
    return cosmos.sumAllDistances()
}

private data class XY(val x: Int, val y: Int)

private class Cosmos private constructor(private val rows: List<List<String>>, private val dilation: Long) {
    private val emptyLinesIndexes = mutableListOf<Int>()
    private val emptyColumnsIndexes = mutableListOf<Int>()
    private val galaxiesLocations = mutableListOf<XY>()

    fun expand() {
        expandRows()
        expandColumns()
    }

    fun locateGalaxies() {
        rows.onEachIndexed { x, row ->
            row.onEachIndexed { y, element ->
                if (element == "#") {
                    galaxiesLocations.add(XY(x, y))
                }
            }
        }
    }

    fun sumAllDistances(): Long =
        galaxiesLocations.mapIndexed { currentIndex, galaxy ->
            galaxiesLocations.mapIndexed { otherIndex, otherGalaxy ->
                if (otherIndex > currentIndex) {
                    distanceBetween(galaxy, otherGalaxy)
                } else {
                    0
                }
            }
        }.sumOf { it.sum() }

    private fun distanceBetween(g1: XY, g2: XY): Long {
        val minX = min(g1.x, g2.x)
        val maxX = max(g1.x, g2.x)
        val minY = min(g1.y, g2.y)
        val maxY = max(g1.y, g2.y)

        val xDilations = emptyLinesIndexes.count { index -> index in minX..maxX }
        val yDilations = emptyColumnsIndexes.count { index -> index in minY..maxY }

        val xDist = maxX - minX - xDilations + dilation * xDilations
        val yDist = maxY - minY - yDilations + dilation * yDilations

        return xDist + yDist

    }

    private fun expandRows() {
        emptyLinesIndexes.addAll(rows
            .mapIndexed { index, chars ->
                index to chars.takeUnless { row -> row.any { it != "." } }
            }
            .filter { it.second != null }
            .map { it.first }
        )
    }

    private fun expandColumns() {
        emptyColumnsIndexes.addAll((0..<rows.first().size)
            .map { column ->
                column to rows.map { it[column] }.takeUnless { it.any { it != "." } }
            }
            .filter { it.second != null }
            .map { it.first }
        )
    }

    companion object {
        fun create(input: String, dilation: Long = 1): Cosmos =
            Cosmos(input.toTwoDimensionalMatrix(), dilation)
    }
}

private val sampleInput = """
    ...#......
    .......#..
    #.........
    ..........
    ......#...
    .#........
    .........#
    ..........
    .......#..
    #...#.....
""".trimIndent()

private val input = """
    ...........................#.............#..........#.........#..................#.......#.............................................#....
    ..............#...........................................................................................#...............#.................
    .....................#......................................................................................................................
    ...................................#................................#................................................#....................#.
    .................#.......................................................#..........#..................#.............................#......
    ...............................................................................................#.................#..........................
    ......................................................#........................#........................................#...................
    ........#.....................................................#...........................#.................#...............................
    .........................................#.....#...............................................................................#............
    ...........................#.........................................................#...................................................#..
    .....#................................................................#............................................................#........
    .............#..........................................#.......................................#.................#.........#...............
    ............................................#...............................................................................................
    .#...............#.....................#....................................#.............................#................................#
    ............................#....................#..........................................................................................
    ...................................................................................................#..........#.............................
    .......#............#.........................................#........#.........................................................#..........
    ..............#.................................................................#..........#............................#...................
    ................................#........................................................................................................#..
    ...............................................#.....................................................#...........#..........................
    #...............................................................#...........................................................................
    ............#......#...................................#....................................................#.............#.........#.......
    .......................................................................................#....................................................
    ....................................#........................#......#...........................#...........................................
    .........#.....#.............#............#.....................................#.....................................#.....................
    ..........................................................................................................#.....#...............#..........#
    ........................................................#...................................................................................
    ..........................#.................................................................................................................
    ....#..................................................................#..................................................#.................
    .....................#..........................................#...........................#.........#.....................................
    ...........#.........................#.......................................#......#.................................................#.....
    #...............................................................................................#..................#............#...........
    ............................#.............#.........#.......................................................................................
    ........#...........................................................#.......................................................................
    .........................................................................#..........................#.......................................
    ..#..........#............................................#.....#.....................#...............................#.....................
    .....................................#...............................................................................................#......
    ....................#......................#....................................................................................#...........
    .....#......................................................................................................................................
    ................................#....................#............................#.........................................................
    ........................#......................................................................#.............................#..............
    .......................................................................#....................................................................
    ..............#.................................#......................................................#.......#..................#.......#.
    ............................................................#............................#..................................................
    ..........................................................................................................................#.................
    ..#.................#.........#............................................#.......#........................................................
    .......#.............................................#........................................#.......................#.....................
    ...............................................................#.................................................................#..........
    ...........................#...............#.......................................................#.....................................#..
    .................................#..............#...............................................................#...........................
    ...............#........................................................................#...................................................
    .........................................................#......................................#..........#................................
    ..#......................................#................................#.................................................................
    ...............................#............................................................#..............................................#
    ..........#........#............................................#...............................................................#...........
    ................................................................................#..................#...........#..........#.................
    ..................................#........#................................................................................................
    ............................................................................................................................................
    .....................#............................................#............................#.......#.....................#..............
    ............................#........................#.....................#..........#..........................#.....................#....
    .........................................................................................................................#..................
    .#.........#...........................#.......................#...................................#........................................
    ................#........#.....................................................................................................#..........#.
    ...........................................................................................#.................#..............................
    ...............................#......................................#............................................#........................
    .........................................#.......#......................................................#...................................
    ..........#..................................................#.................#............................................................
    #.......................#..............................................................#...........................................#.......#
    .................................#......................#........................................................#........#.................
    ............................................................................................................................................
    ...............................................#...............................................#............................................
    ................#.....................#.......................................#.............................................................
    ......................................................#...............#.....................................................................
    ...................................................................................#.............................................#..........
    ..................................................................#........#....................................#...........................
    .#.......................................................#.................................#............#...................................
    ............................................................................................................................................
    ........#.......................#................................................#.........................................#................
    ..................#......#......................................................................#...........................................
    ......................................#...............#..........#.....................................................................#....
    ...#....................................................................................#...................................................
    ...............#..............................#.............................#...............................................................
    ...................................#..............................................................#.....#........................#.........#
    .......#............#...................................................................................................#...................
    ...........................#.................................................................#................#.............................
    .....................................................#...............................................#......................................
    ...........#..............................................#.................................................................................
    ..............................................#.................#...............#.........#.................................................
    ................#.......#...........#.................................#...................................#.................................
    .....................................................................................#...........#...................#......................
    ........................................................#......................................................................#.......#....
    .....#......................#...............................................................................................................
    .............#........#..........................#..........................................................#.............#................#
    ............................................................................................................................................
    ........#............................#............................................#..........#..............................................
    ............................................#...................................................................#...........................
    ............................................................................................................................................
    ..#..............#......#.........................................#...............................#.........................................
    ....................................................#......................#.......................................................#......#.
    ...................................#........................#................................................................#..............
    .....................................................................#...........#..........................................................
    ...............#.............................#...........................................................#..................................
    ..........#..............................................................................#.....#.................#..........................
    .....................................................................................................................................#......
    .#................................#.........................................................................#...............................
    ........................#.........................................#......#.........#................#.......................................
    .................#........................................#..................................................................#..............
    ........................................#...................................................................................................
    ....#.....#........................................#............................................#...........................................
    ............................................................................................................................................
    ..............................................................................#.....................................#................#......
    .....................#................................................................#.........................................#...........
    .............................#.........#........#.........#.............#...........................#.......................................
    ................................................................#.........................#..................#............#.............#...
    ........#.......................................................................#...........................................................
    ........................#..................#............................................................#...................................
    .....................................#.................................................#.........#................#.........................
    ...................................................#.....................#....................................................#............#
    ............................................................................................................................................
    ................#..............................................#.................#............................#.............................
    ....#........................#..........................#............#......................................................................
    ....................................#........................................................#..............................................
    .......................#..........................................................................#.....#...........#............#..........
    ........#..................................#................#.............#...........................................................#.....
    ................................................#.......................................................................#..................#
    ..................#.................................................................#.......................................................
    ............#........................#...........................................................................#.............#............
    ...#........................................................................................................................................
    ..........................................#.................................#................#..............................................
    .......................#............................#.............#...................................................#.............#.......
    .................................#....................................................#........................#............................
    .................................................................................#........................................................#.
    ..........................................................#.............................................#...................................
    ...#............#...........................................................................................................................
    ..............................................#...................................................#.........................................
    .........................................................................#.....#.......#.........................................#..........
    ............#.........#......................................................................#........#.....................................
    ...........................#........................................#........................................#.......................#......
    .....#.................................#..............#........#.....................................................#......................
    ...............................#............................................#........#....................................#.................
""".trimIndent()